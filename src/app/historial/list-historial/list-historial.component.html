<div class="reserva-rectangulo mx-3 mt-4 mb-3 shadow">
  <div class="d-flex align-items-center gap-4 w-100">
    <i class="bx bxs-filter-alt filtro-icono me-2"></i>
    <h5 class="mb-0 fw-bold">Filtros</h5>
    <div class="d-flex align-items-center gap-4 ms-auto">
      <div class="d-flex align-items-center">
        <label for="matricula" class="me-2 mb-0">Matrícula:</label>
        <input id="matricula" name="matricula" type="text" class="form-control" placeholder="Ej. ABC1234"
          style="width: 150px;" [(ngModel)]="filtroMatricula" [disabled]="loading">
      </div>
      <div class="d-flex align-items-center">
        <label for="fechaEvento" class="me-2 mb-0">Fecha evento:</label>
        <input id="fechaEvento" name="fechaEvento" type="date" class="form-control" style="width: 150px;"
          [(ngModel)]="filtroFechaEvento" [disabled]="loading">
      </div>
      <button class="btn btn-outline-secondary btn-sm" (click)="clearFilters()" [disabled]="loading">
        Limpiar Filtros
      </button>
    </div>
  </div>
</div>

<div class="contenedor-tabla shadow">
  <!-- Estados de carga y error -->
  <div *ngIf="loading" class="text-center py-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-2 mb-0">Cargando historial de vehículos...</p>
  </div>

  <div *ngIf="error && !loading" class="alert alert-danger mx-3 mt-3" role="alert">
    <div class="d-flex align-items-center">
      <i class="bx bx-error-circle me-2"></i>
      <span>{{ error }}</span>
      <button class="btn btn-outline-danger btn-sm ms-auto" (click)="loadHistoriales()">
        Reintentar
      </button>
    </div>
  </div>

  <!-- Header con título y botón dentro del contenedor -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center">
      <i class="bx bx-menu me-3" style="font-size: 2rem; color: #333;"></i>
      <h3 class="mb-0 fw-bold text-dark">Historial de Vehículos</h3>
    </div>
    <button *ngIf="puedesCrearHistorial()" class="btn btn-success d-flex align-items-center custom-btn"
      (click)="openModal()" [disabled]="loading">
      <i class="bx bx-plus me-2"></i>
      Agregar Historial
    </button>
  </div>

  <!-- Tabla de datos -->
  <div *ngIf="!loading && !error">
    <div *ngIf="historialesFiltrados.length === 0" class="text-center py-5">
      <i class="bx bx-history" style="font-size: 3rem; color: #6c757d;"></i>
      <p class="mt-3 text-muted">No se encontraron registros de historial</p>
      <button class="btn btn-primary" (click)="openModal()">
        Crear Primer Evento
      </button>
    </div>

    <div class="table-responsive">
      <table *ngIf="historialesFiltrados.length > 0" class="table table-hover mb-0">
        <thead>
          <tr>
            <th class="text-center">Vehículo</th>
            <th class="text-center">Usuario Responsable</th>
            <th class="text-center">Fecha</th>
            <th class="text-center">Descripción</th>
            <th class="text-center">Evento</th>
            <th *ngIf="mostrarAcciones()" class="text-center">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let historial of historialesFiltrados">
            <!-- Columna Vehículo -->
            <td class="text-center">
              {{ historial.vehiculo?.matricula || 'Sin matrícula' }}
            </td>

            <!-- Columna Usuario Responsable -->
            <td class="text-center">
              {{ getNombreUsuario(historial) }}
            </td>

            <!-- Columna Fecha -->
            <td class="text-center">
              {{ formatDate(historial.fecha_evento) }}
            </td>

            <!-- Columna Descripción -->
            <td class="text-center">
              {{ historial.descripcion || 'Sin descripción' }}
            </td>

            <!-- Columna Evento -->
            <td class="text-center">
              {{ historial.tipo_evento | titlecase }}
            </td>

            <!-- Columna Acciones -->
            <td *ngIf="mostrarAcciones()" class="text-center">
              <button class="btn btn-link text-primary p-0 me-2" (click)="editarHistorial(historial)" title="Editar">
                <i class='bx bx-edit'></i>
              </button>
              <button *ngIf="permisos.puedeEliminarHistorial()" class="btn btn-link text-danger p-0"
                (click)="eliminarHistorial(historial)" title="Eliminar">
                <i class='bx bx-trash'></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <app-new-historial [isOpen]="isModalOpen" (closeModal)="closeModal()" (saveHistorial)="onSaveHistorial($event)">
  </app-new-historial>

  <app-edit-historial [isOpen]="isEditModalOpen" [historialToEdit]="historialToEdit" (closeModal)="closeEditModal()"
    (updateHistorial)="onUpdateHistorial($event)">
  </app-edit-historial>